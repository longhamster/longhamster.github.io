<html>
  <head>

    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Source+Sans+Pro" rel="stylesheet">

    <style>
      body {
        margin:0;
      }
      h3 {
        font-family: 'Roboto Condensed', sans-serif;
        font-size:1.5em;
        color:white;
        letter-spacing: 3px;
      }
      p {
        font-family: 'Source Sans Pro', sans-serif;
        font-size:.9em;
        color:white;
        line-height: 1.5em;
        letter-spacing: .5px;
      }
      #map {
        width: 100%;
        height: 100%;
        background-color: grey;
      }
      .container {
        width:100%;
        height:100%;
        position:relative;
        padding:0 0 0 0px;
      }
      #sidebar {
        position:absolute;
        top:0;
        bottom:0;
        right:0;
        width:300px;
        background:#E85E40;
        padding: 25px;
      }
      #timeline {
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        height:40px;
        background:rgba(255,255,255,0.8);
        padding: 25px;
      }
      .foodPlaces, .foodPlaces svg {
        position: absolute;
      }
      .foodPlaces svg {
        width:50px;
        height:50px;
        padding-right: 100px;
        font: 10px sans-serif;
      }
      .foodPlaces circle {
        fill: red;
        stroke: black;
        stroke-width: 1.5px;
      }
      .arc text {
        font: 10px sans-serif;
        text-anchor: middle;
      }

      .arc path {
        stroke: #fff;
      }
    </style>

  </head>

  <body>

    <div class="container">
      <div id="map"></div>
      <div id="timeline">
        <input type="range" id="slider">
        <input type="text" id="textBox"/>
      </div>
      <div id="sidebar">
        <div class="siderbarInnards">
          <h3>CHICKEN</h3>
          <svg></svg>
          <p>
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
            chicken chicken chicken chicken chicken chicken
           </p>
         </div>
       </div>
     </div>

  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script>

// GOOGLE MAP ------------------------------------------------
    var map;
    var years = [];
    var yearData = [];

    function initMap() {
      var mapCenter = {lat: 42.339747, lng: -71.089164};
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 17,
        center: mapCenter,
        draggable: false,
        zoomControl: false,
        panControl: false,
        scaleControl: false,
        scrollwheel: false,
        disableDoubleClickZoom: true,
        clickableLabels: false,
        clickable: false
      });

      google.maps.event.addDomListener(window, "resize", function() {
        var center = map.getCenter();
        google.maps.event.trigger(map, "resize");
        map.setCenter(center);
      });
    }

// FILTER BY YEAR ----------------------------------------------

    d3.csv("TESTDATA1.csv", function(error, data) {

      if (error) throw error;

      data.forEach(function(d) {
        d.Year = new Date(d.VIOLDTTM).getFullYear();
        var num = parseFloat(d.Year)
        years.push(num);
      });

      var nestedData = d3.nest()
        .key(function(d, i) {
          return d.Year;
        })
        .key(function(d, i) {
          return d.Location;
        })
        .entries(data);

      nestedData = nestedData.filter(function(d, i){
        d.values = d.values.filter(function(l){
          return l.key !="";
        })
        return d.key !="";
      });

      console.log(nestedData);

// YEAR SLIDER ----------------------------------------------

      var defaultValue = d3.min(years);
      d3.select("#textBox").node().value = defaultValue;

      d3.select("#slider")
        .attr("min", d3.min(years))
        .attr("max", d3.max(years))
        .attr("value", defaultValue)
        .on("input", function() {

          d3.select("#textBox").node().value = this.value;
          overlay.draw(this.value);

        });


      var overlay = new google.maps.OverlayView();

      overlay.onAdd = function() {
        var layer = d3.select(this.getPanes().overlayLayer).append("div")
          .attr("class", "foodPlaces");

        overlay.draw = function(year) {

          console.log(year);

          var yearData = nestedData.filter(function(d) {
            return d.key === (year || defaultValue) + "";
          })[0].values;

          console.log(yearData);

          var projection = this.getProjection(),
              padding = 10;

          var marker = layer.selectAll("svg.marker")
              .data(yearData, function(d, i){
                return d.key;
              });

          var markerEnter = marker.enter().append("svg")
            .attr("class", "marker");

          // Add a circle.
          markerEnter.append("circle");

          // Add a label.
          markerEnter.append("text")
              .attr("x", padding + 7)
              .attr("y", padding)
              .attr("dy", ".31em")
              .text(function(d) {
                return d.values[0].BusinessName;
              });

          var markerUpdate = markerEnter.merge(marker);
          markerUpdate.each(transform);
          markerUpdate.select("circle")
            .attr("r", 4.5)
            .attr("cx", padding)
            .attr("cy", padding);
          var markerExit = marker.exit().remove();

          function transform(d) {
            var coords = d.key
              .replace("(", "")
              .replace(")", "")
              .replace(" ", "")
              .split(",")
              .map(Number);
            // console.log(coords);
            d = new google.maps.LatLng(coords[0], coords[1]);
            d = projection.fromLatLngToDivPixel(d);
            return d3.select(this)
                .style("left", (d.x - padding) + "px")
                .style("top", (d.y - padding) + "px");
          }
        };
      };
      overlay.setMap(map);

    });

// DRAW PIE CHART BASED ON VIOL LEVELS -----------------

    var width = 960,
    height = 500,
    radius = Math.min(width, height) / 2;

    var color = d3.scaleOrdinal()
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

    var arc = d3.arc()
        .outerRadius(radius - 10)
        .innerRadius(0);

    var labelArc = d3.arc()
        .outerRadius(radius - 40)
        .innerRadius(radius - 40);

    var pie = d3.pie()
        .sort(null)
        .value(function(d) {
          var num = d.ViolLevel;
          if ("*") {
            return 1;
          }
          if ("**") {
            return 2;
          }
          if ("***") {
            return 3;
          }
        });

    var svg = d3.select("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    d3.csv("TESTDATA1.csv", type, function(error, data) {
      if (error) throw error;

      var g = svg.selectAll(".arc")
          .data(pie(data))
        .enter().append("g")
          .attr("class", "arc");

      g.append("path")
          .attr("d", arc)
          .style("fill", function(d) { return color(d.data.age); });

      g.append("text")
          .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
          .attr("dy", ".35em")
          .text(function(d) { return d.data.age; });
    });

    function type(d) {
      d.population = +d.population;
      return d;
    }

  </script>

  <script async defer src=
  "https://maps.googleapis.com/maps/api/js?key=AIzaSyD_VF4Af60Yb3zcIfn5WDWjd7Z-tNufhH8&callback=initMap">
  </script>

  </body>
</html>
