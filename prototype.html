<html>
  <head>

    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Source+Sans+Pro" rel="stylesheet">

    <style>
      body {
        margin:0;
      }
      h3 {
        font-family: 'Roboto Condensed', sans-serif;
        font-size:1.5em;
        color:white;
        letter-spacing: 3px;
      }
      p {
        font-family: 'Source Sans Pro', sans-serif;
        font-size:.9em;
        color:white;
        line-height: 1.5em;
        letter-spacing: .5px;
      }
      li {
        font-family: 'Source Sans Pro', sans-serif;
        font-size:.8em;
        color:white;
        line-height: 1.5em;
        letter-spacing: .5px;
        list-style-type: none;
      }
      ul {
        height:250px;
        overflow:hidden;
        overflow-y:scroll;
      }
      #map {
        width: 100%;
        height: 100%;
        background-color: grey;
      }
      .container {
        width:100%;
        height:100%;
        position:relative;
        padding:0 0 0 0px;
      }
      #sidebar {
        position:absolute;
        top:0;
        bottom:0;
        right:0;
        width:300px;
        background:#E85E40;
        padding: 25px;
      }
      #timeline {
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        height:40px;
        background:rgba(255,255,255,0.8);
        padding: 25px;
      }
      .foodPlaces, .foodPlaces svg {
        position: absolute;
      }
      .foodPlaces svg {
        width:50px;
        height:50px;
        padding-right: 100px;
        font: 10px sans-serif;
      }
      .foodPlaces circle {
        stroke: black;
        stroke-width: 1.5px;
      }
      .arc text {
        font: 10px sans-serif;
        text-anchor: middle;
      }

      .arc path {
        stroke: #fff;
      }
    </style>

  </head>

  <body>

    <div class="container">
      <div id="map"></div>
      <div id="label" style="display: none; left: 18px; top: 52px;">Dave</div>
      <div id="timeline">
        <input type="range" id="slider">
        <input type="text" id="textBox"/>
      </div>
      <div id="sidebar">
        <div class="siderbarInnards">
          <h3 id="name"></h3>
          <svg id="pieChartSVG"></svg>
          <ul id="testList">
            <li>
            </li>
          </ul>
         </div>
       </div>
     </div>

  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script>

// GOOGLE MAP ------------------------------------------------
    var map;
    var years = [];
    var yearData = [];

    function initMap() {
      var mapCenter = {lat: 42.339747, lng: -71.089164};
      map = new google.maps.Map(document.getElementById('map'), {
         zoom: 17,
         center: mapCenter,
         draggable: false,
         zoomControl: false,
        // panControl: false,
        // scaleControl: false,
         scrollwheel: false,
         disableDoubleClickZoom: true,
        // clickableLabels: false
      });

      google.maps.event.addDomListener(window, "resize", function() {
        var center = map.getCenter();
        google.maps.event.trigger(map, "resize");
        map.setCenter(center);
      });
    }

// FILTER BY YEAR ----------------------------------------------

    d3.csv("TESTDATA1.csv", function(error, data) {

      if (error) throw error;

      data.forEach(function(d) {
        d.Year = new Date(d.VIOLDTTM).getFullYear();
        var num = parseFloat(d.Year)
        years.push(num);
      });

      var nestedData = d3.nest()
        .key(function(d, i) {
          return d.Year;
        })
        .key(function(d, i) {
          return d.Location;
        })
        .entries(data);

      nestedData = nestedData.filter(function(d, i){
        d.values = d.values.filter(function(l){
          return l.key !="";
        })
        return d.key !="";
      });

      console.log(nestedData);

// YEAR SLIDER ----------------------------------------------

      var defaultValue = d3.min(years);
      d3.select("#textBox").node().value = defaultValue;

      d3.select("#slider")
        .attr("min", d3.min(years))
        .attr("max", d3.max(years))
        .attr("value", defaultValue)
        .on("input", function() {

          d3.select("#textBox").node().value = this.value;
          overlay.draw(this.value);

        });

      var overlay = new google.maps.OverlayView();

      overlay.onAdd = function() {
        var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
          .attr("class", "foodPlaces")
          .style("z-index", "-10");

        overlay.draw = function(year) {

          //console.log(year);

          var yearData = nestedData.filter(function(d) {
            return d.key === (year || defaultValue) + "";
          })[0].values;

          //console.log(yearData);

          var projection = this.getProjection(),
              padding = 10;

          var marker = layer.selectAll("svg.marker")
              .data(yearData, function(d, i){
                return d.key;
              })
              .on("click", function(d) {
                document.getElementById('name').innerHTML = d.values[0].BusinessName;
              })
              // .on("mousemove", function(d) {
              //   var position = d3.mouse(d3.select("body").node());
              //   d3.select("#label")
              //     .style("display", "block")
              //     .style("left", position[0] - 50 + "px")
              //     .style("top", position[1] - 20 + "px")
              //     .style("z-index", "10")
              //     .text(d.values[0].BusinessName);
              // })
              // .on("mouseleave", function() {
              //   d3.select("#label").style("display", "none");
              // })
              ;

          var markerEnter = marker.enter().append("svg")
            .attr("class", "marker");

          // Add a circle.
          markerEnter.append("circle");

          // Add a label.
          markerEnter.append("text")
              .attr("x", padding + 7)
              .attr("y", padding)
              .attr("dy", ".31em")
              .text(function(d) {
                return d.values[0].BusinessName;
              });

          var color2 = d3.scaleLinear()
          .domain([1, 2 ,3])
          .range(["#FF0", "#FFA500", "#F00"]);

          var markerUpdate = markerEnter.merge(marker);
          markerUpdate.each(transform);
          markerUpdate.select("circle")
            .attr("r", function(d) {
              var scale = d3.scaleLinear()
                .domain([ 0 , 50 ])
                .range([ 5, 10 ]);
              return (scale(d.values.length))
            })
            // .transition().duration(300)
            .attr("cx", padding)
            .attr("cy", padding)
            .attr("fill", function(d, i){
              console.log(d);
              var avg = 0;

              for (var n = 0; n < d.values.length; n++) {
                var str = d.values[n].ViolLevel;
                avg = avg + str.length;
                console.log(str.length);
              }

              avg = avg/d.values.length;
              console.log(avg);

              return color2(avg);
            })
            .on("click", function(d) {
              d3.select('#name').html(d.values[0].BusinessName);
              var list = d3.select('#testList').html("");
              for (var i = 0; i < d.values.length; i++) {
                list.append('li').text(d.values[i].ViolDesc);
              };

// DRAW PIE CHART BASED ON VIOL LEVELS -----------------

              var pieNestedData = d3.nest()
                .key(function(x) {
                  return x.ViolLevel;
                })
                .entries(d.values);

              pieNestedData.forEach(function(d, i){
                var amount = d.values.length;
                console.log(pieNestedData[i].key + " " + amount)
              });

              var arc = d3.arc()
                .outerRadius(80-10)
                .innerRadius(0);

              var pieData = d3.pie().value(function(d){
                return d.values.length
              })(pieNestedData);

              console.log(pieData);

              var color = d3.scaleOrdinal()
                .domain(["*", "**", "***"])
                .range(["#FF0", "#FFA500", "#F00"]);

              var pieGroup = d3.select("#pieChartSVG")
               .append("g")
               .attr("transform", "translate(" + 100 + "," + 150 / 2 + ")")
               ;

               var pieSlices = pieGroup.selectAll("path").data(pieData);

               pieSlices.enter().append("path")
                .attr("d", arc)
                .style("fill", function(d, i  ) {
                  return color(d.data.key);
                });

              })

          var markerExit = marker.exit().remove();

          function transform(d) {
            var coords = d.key
              .replace("(", "")
              .replace(")", "")
              .replace(" ", "")
              .split(",")
              .map(Number);
            // console.log(coords);
            d = new google.maps.LatLng(coords[0], coords[1]);
            d = projection.fromLatLngToDivPixel(d);
            return d3.select(this)
                .style("left", (d.x - padding) + "px")
                .style("top", (d.y - padding) + "px");
          }
        };
      };
      overlay.setMap(map);

  });

  </script>

  <script async defer src=
  "https://maps.googleapis.com/maps/api/js?key=AIzaSyD_VF4Af60Yb3zcIfn5WDWjd7Z-tNufhH8&callback=initMap">
  </script>

  </body>
</html>
